[tox]
envlist = tests
skipsdist = true
requires =
    tox>=3.25.0,<4
    tox-envfile
    tox-faster
    tox-run-command

[testenv]
skip_install = true
setenv =
    PYTHONUNBUFFERED = 1
    OBJC_DISABLE_INITIALIZE_FORK_SAFETY = YES
    dev: DEV = {env:DEV:true}
    dev: ENABLE_WEB = {env:ENABLE_WEB:true}
    dev: SENTRY_ENVIRONMENT = {env:SENTRY_ENVIRONMENT:dev}
    dev: NEW_RELIC_APP_NAME = {env:NEW_RELIC_APP_NAME:h}
    dev: NEW_RELIC_ENVIRONMENT = {env:NEW_RELIC_ENVIRONMENT:dev}
    dev,tests,functests: PYTHONDEVMODE = {env:PYTHONDEVMODE:1}
    tests,functests: PYTEST_PLUGINS = tests.pytest_plugins.factory_boy
    tests: COVERAGE_FILE = {env:COVERAGE_FILE:.coverage.{envname}}
    dev: ALEMBIC_CONFIG = {env:ALEMBIC_CONFIG:conf/alembic.ini}
    dev: DATABASE_URL = {env:DATABASE_URL:postgresql://postgres@localhost:5432/postgres}
    tests: DATABASE_URL = {env:UNITTESTS_DATABASE_URL:postgresql://postgres@localhost:5432/h_tests}
    functests: DATABASE_URL = {env:FUNCTESTS_DATABASE_URL:postgresql://postgres@localhost:5432/h_functests}
    # Make `import h` work in `make shell`.
    dev: PYTHONPATH = .
    dev: WEB_CONCURRENCY = {env:WEB_CONCURRENCY:2}
    REPORT_FDW_USERS=lms-fdw report-fdw
    dev,tests,functests: ELASTICSEARCH_URL = {env:ELASTICSEARCH_URL:http://localhost:9200}
    tests: ELASTICSEARCH_INDEX = hypothesis-tests
    functests: ELASTICSEARCH_INDEX = hypothesis-functests
    dev: APP_URL = {env:APP_URL:http://localhost:5000}
    dev: WEBSOCKET_URL = {env:WEBSOCKET_URL:ws://localhost:5001/ws}
    dev: ENABLE_WEBSOCKET = {env:ENABLE_WEBSOCKET:true}
    dev: ENABLE_WORKER = {env:ENABLE_WORKER:true}
    dev: ENABLE_ASSETS = {env:ENABLE_ASSETS:true}
    dev: JWE_SECRET_LMS = {env:JWE_SECRET_LMS:SUPER_SECRET}
    dev: SECRET_KEY = notverysecretafterall
    dev: AUTHORITY = localhost
    SQLALCHEMY_SILENCE_UBER_WARNING = {env:SQLALCHEMY_SILENCE_UBER_WARNING:1}
passenv =
    HOME
    PYTEST_ADDOPTS
    dev: DEBUG
    dev: SENTRY_DSN
    dev: NEW_RELIC_LICENSE_KEY
    GUNICORN_CERTFILE
    GUNICORN_KEYFILE
    dev: AUTHORITY
    dev: BOUNCER_URL
    dev: CLIENT_OAUTH_ID
    dev: CLIENT_RPC_ALLOWED_ORIGINS
    dev: CLIENT_URL
    dev: GOOGLE_ANALYTICS_TRACKING_ID
    dev: H_GUNICORN_CERTFILE
    dev: H_GUNICORN_KEYFILE
    dev: SENTRY_DSN_CLIENT
    dev: SENTRY_DSN_FRONTEND
    dev: USE_HTTPS
    dev: NODE_ENV
    dev: PROXY_AUTH
    functests: BROKER_URL
deps =
    pip-tools
    pip-sync-faster
depends =
    coverage: tests
allowlist_externals =
    tests,functests: sh
commands_pre =
    pip-sync-faster requirements/{env:TOX_ENV_NAME}.txt --pip-args '--disable-pip-version-check'
commands =
    tests: sh bin/create-db h_tests
    functests: sh bin/create-db h_functests
    dev: {posargs:supervisord -c conf/supervisord-dev.conf}
    format: black h tests bin
    format: isort --atomic h tests bin
    checkformatting: black --check h tests bin
    checkformatting: isort --quiet --check-only h tests bin
    lint: pylint h bin
    lint: pylint --rcfile=tests/pyproject.toml tests
    lint: pydocstyle h tests bin
    lint: pycodestyle h tests bin
    tests: python -m pytest --cov --cov-report= --cov-fail-under=0 --numprocesses logical --dist loadgroup --failed-first --new-first --no-header --quiet {posargs:tests/unit/}
    functests: python -m pytest --failed-first --new-first --no-header --quiet {posargs:tests/functional/}
    coverage: coverage combine
    coverage: coverage report
    template: python3 bin/make_template {posargs}
    docs: sphinx-autobuild -qT --open-browser -b dirhtml -d {envdir}/doctrees docs {envdir}/html
    checkdocs: sphinx-build -qTWn -b dirhtml -d {envdir}/doctrees docs {envdir}/html

[testenv:dev]
# By default when you Ctrl-c the `make dev` command tox is too aggressive about
# killing supervisor. tox kills supervisor before supervisor has had time to
# stop or kill its child processes, resulting in detached child processes being
# left running and other problems.
#
# Fix this by configuring tox to wait a long time before sending any further
# SIGINTs (after the first one) or SIGTERMs or SIGKILLs to supervisor.
# Just trust supervisor to clean up all its child processes and stop.
suicide_timeout = 60.0
interrupt_timeout = 60.0
terminate_timeout = 60.0
